<%= include ActionView::Helpers::AssetUrlHelper %>
import {
  work,
  play,
  chat,
  dumpster,
  textEditor,
  moveWindow,
  resizeWindow,
  appIcon,
} from './windows.js';

import {
  titleScreen,
  quiz,
  runQuiz,
} from './intro.js'

import {
  gameOver
} from './game_over.js'

var WM = require('simple-window-manager');
const wm = new WM({
  borderRadius: '10px'
})

var score = 12;
var quizWindow = quiz(wm);
var titleScreenWindow = titleScreen(wm);
var movementInterval = 4000;
var resizeInterval = 2000;
var videos = [
  'v538817827',
  'v538881620',
  'v538884216'
]
var wallpapers = [
  '<%= image_path('windows.jpg') %>',
  '<%= image_path('tiger.jpg') %>',
  '<%= image_path('snow_leopard.jpg') %>'
]

window.onload = () =>
{
// titleScreenWindow.open();
// document.getElementById('start-game').addEventListener('click', function(event) {
//   event.preventDefault();
//   titleScreenWindow.close();
//   var audio = document.getElementById('audio-introduction');
//   audio.addEventListener('ended', function() {
//     quizWindow.open();
//   });
//   audio.play()
// });
// document.addEventListener('calculateScore', function(event) {
//   score = event.detail;
// });
//
// runQuiz();
//
// // run game loop
// document.getElementById('submit-quiz').addEventListener('click', function(event) {
//   event.preventDefault();
//   quizWindow.close();
   desktop(score);
//   startGameTimer(wm);
// });
}

function startGameTimer(wm) {
  window.setTimeout(function() {
    console.log('sending game over event');
    var event = new Event('gameOver');
    document.dispatchEvent(event);
  }, 500000);

  document.addEventListener('gameOver', function() {
    console.log('game over event recieved by document');
    gameOver(wm);
  });
}

function desktop(score) {
  var workWindow = work(wm);
  var video = scoreToAttribute(score, videos);
  var bg = scoreToAttribute(score, wallpapers)
  var playWindow = play(video, wm);

  wm.overlay.style.backgroundImage = `url(${bg})`;
  wm.overlay.style.backgroundSize = `cover`;
  appIcon('work', workWindow, 20, 20, '<%= image_path('work.png') %>', wm).open({ noFocus: true });
  appIcon('play', playWindow, 140, 20, '<%= image_path('twitch.png') %>', wm).open({ noFocus: true });
  appIcon('text', textEditor(wm), 260, 20, '<%= image_path('text.png') %>', wm).open({ noFocus: true });
  appIcon('trash', dumpster(wm), 380, 20, '<%= image_path('trash.png') %>', wm).open({ noFocus: true });
  appIcon('chat', chat(wm), 500, 20, '<%= image_path('chat.png') %>', wm).open({ noFocus: true });

  playWindow.on('open', function() {
    // Always keep play window on top
    setInterval(function() {
      playWindow.sendToFront();
    }, 100);

    // Set move window interval
    window.setInterval(function() {
      var timeUntilMove = Math.random() * movementInterval;
      if(Math.random() > 0.5) {
        window.setTimeout(function() {
          moveWindow(playWindow, workWindow, (5 + (Math.random() * 10)));
        }, timeUntilMove);;
      }
    }, movementInterval);

    // Set resize window interval
    window.setInterval(function() {
      var timeUntilResize = Math.random() * resizeInterval;
      if(Math.random() > 0.5) {
        window.setTimeout(function() {
          resizeWindow(playWindow, Math.random() * 10);
        }, timeUntilResize);;
      }
    }, resizeInterval);
  });

  function scoreToAttribute(score, arr) {
    if(score <= 8.33) {
      return arr[0];
    } else if (score <= 11.66) {
      return arr[1];
    } else {
      return arr[2];
    }
  }
}
